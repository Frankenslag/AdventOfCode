
namespace AdventOfCode2023
{
    internal class Day16
    {
        private static readonly string[] DataProd =
        [
            @"\..\/|../.-..-....................................|.-..-.......|...--........-......\...\........\............",
            @"..\...|.\.........|..|.....................|.....\.........................................-.......|-..../....",
            @"......\\\........\............-........\............/.....-|..............|....................\....-.........",
            @"................................-..\-.........\.-....-.............................|........\...............\.",
            @"................\/..........\................/...........................|./......|...........|...............",
            @"......../....|..-........|./..../......................../............./-/....-.....................\.........",
            @"../..|/.|.............\..\\.............../...................../..............|....................-.........",
            @"...........................\..\......./................/....\......................-........|................/",
            @"..........|../.....|./........-.\......../.................../........................|..../......|...........",
            @".........../...../....................-....|.-..........-.........\../..\...\../..|../........|.....\.........",
            @".../........\/....../.......................-......................-|..../.../...-.......-.../................",
            @"..........|.....-.././.....|../.\.....................-.......................................-....|.|...|....",
            @"............./...-...................|.-...|.-........-.......|..............|......-.........................",
            @"........\\..\.................\........-............/|......-.......|........................./.......|.....\.",
            @"....|..../..\........................./....|/......../.......-..........|/..........................-.........",
            @".............\...............................................\......\........./.....-..../..\......-...-.....|",
            @".........../.................../...........-......../|.............../.................\../...\...............",
            @"................/-.......-......................./....................................-..................|...\",
            @"......................................|..................-....\...............|.../.........|..|..|...../.-...",
            @".\......-./..-....\.....\............./...-......\........................-./..//.......-........|............",
            @"......|...-...\........|........|........./.....\|.....................\........\.........-....\.....|....|...",
            @"....................|.............................-..........................|..........-..../........|.-.....",
            @".-.-.....................|........./.....\........./....\|/..\...........\......./...-.............\.|.../...\",
            @"............/...................................................../../................./.-....................",
            @"................../.........\.|........./............|........|...............................................",
            @".\............/.-..-......|.....|....-........\..............................|....-.|.........|......./......\",
            @"....|..................................-..-......-.............-..-/..........................-........|../...",
            @"-..|-.../................-...............|.......-\.........-....../.\..............///....\............../...",
            @".........../......................|........-....-...|....|...-...|......|.................../........-........",
            @"........|.........../...............\......................|..-.-.....................|.........-.............",
            @"./............/..\......\.....|..\...|........................-.../.......//...|..............\..../\.........",
            @".-...|.-...............\......../.|.../............|.........|../|....././......./........||.\...-............",
            @"................-........-/.............../.....-.\/......................../....................\............",
            @"....\............./..../.........................-.............\...\.../........../................-/...-...|.",
            @"......................................|......./.-....../...................../.....|..........................",
            @".|..................\..........\....-.......-......\..|.-.................-...\.............|......../........",
            @"..|...........|./.................\.........................|.........................-\......................",
            @"../.../.........../.......-.......-/............./..............\........-..........-..|...\.\/.-..|..........",
            @"............./..............-\../..|..\.....................................\............-........-.........|.",
            @".....|-.................|............|/...............................\............/...\.........\............",
            @"........\.....\.....\...........\..........-...........................\.......-.......................\../...",
            @"........./........|..............................-......\.........................|..|.-.....|....../.........",
            @"............-.......\............/...\./.............../\.\..............|............\.../............\......",
            @"...../.....\..............|...............................................-......................./...........",
            @"...../........|.....................-.....................|.../.....................\.../...../..............\",
            @"..........|.........-....................-\............-.....................-...................\..../.......",
            @".............\.........|\..........................\........-.....|.\..............|.......-..\..............\",
            @"............./\..\\............|...-/..........-...................//.\.......\................../..........|.",
            @"........................|.|.....|......\...-.-...\.......|...|...........\.-.............|......|............|",
            @".....|......|.......\.........\................\\......|......................\.............\..\..............",
            @"......................|....../.........|........./.......-...\..............\...||......../..................|",
            @"....|..\.-.................|....\.............../.....-......../......................../....../..........|...",
            @"./.......|............././../.-...-...........\\..|...\......................../........|....-.\..............",
            @"........................|.......|......................-...../....................................../.\.......",
            @"....\..-.....|......................\...............|...|\.......|....../......|....\.-../.............../....",
            @"....../........-\...|.............|.......................\..................-.........\.......-.....-.....-./",
            @".......|....\.............|.......|....\.../........................|.........................................",
            @".....|.........\.../....-......./......\.........................../................-.................\.......",
            @"..|../.../.|.....-../...../..........-....../.\......../........../..................\.....\...-...-...\..|...",
            @"..|...........\.\.........\.....-.............-............../...|........./..........\-......................",
            @"..../...\............\..........-...../.................................................../......-..|........-",
            @"..............\............|................./.\........|.......................|.........\/....-.............",
            @"......................-.............\|...|............../........\|../......../........./.\.../\.............|",
            @"...........\.....................................\.../.............................|..............-../........",
            @"................./...................\......../............................-....\.................\.-.|\......",
            @"....-../................|.......\.-.........|...\.|.........\...........\...|.................././.....\......",
            @"..-....-....../...-...\/...............\.......\.........................|..|..../.....................\......",
            @"/........\......../..............|..............|...|............|...............\............-.|.............",
            @"...\./............/....../......--.......-............-..\........\..................\.......\-............./.",
            @"-..\-..//......-.............\....\-.|........-|......................./................................../...",
            @"...........\......-.........................-.\|...|...........-.....\.......-........|.|.--..|........./.....",
            @".......-........................./............|.............|................./..................-.......|-|./",
            @".......|..........-................../.......................................|..../.......................|...",
            @".....-........../.-../........./\..../.....\...-.....-...............|...../.../.....................\........",
            @".........................|........|\../.../......|.................\..............-|....../..|................",
            @"...\...\.....................|.....|....\............|...|...../...|\............-.-........................-.",
            @"....................\|..............\...../........../..../........................-..........-...........\...",
            @"...\.........................|........-......................./..../................................./........",
            @"|......................./.../............../...\....................-.........................-........../|...",
            @".......-../......../....\...................../........................./......\\......\.........\......../...",
            @"...-.....-......../..-/........\...............................\..........-.....................|........-....",
            @"..-....|............/.|-.........-..............................\.........-.........-....................//-..",
            @"...-\......-../..../...|-............................................\...............\...\...\..|\......|.....",
            @"......../...........-............................-...........................................\.....\.../......",
            @"........................\.......\...\......|.....\..\.-\.............../.......--...../|\.............|/......",
            @".............../...............|....\......-.....|\..................|....-.................-......-........\.",
            @"\.......................-........-......|.................................|..-....-................./.........",
            @".........|............\.........../..\......-.................\...\........./|.|.-.........\............./....",
            @".-.........|................................/\......./..........|......................../........\...........",
            @"......................................\\...................../........................-\........../.-.......-.",
            @"......\....................................../.............................|.../.................\............",
            @"........-...|..-...\...\...........-.............-......................../................\..................",
            @"...../....../.......................\................/....\.-..-..../........|.......-........................",
            @".........|.....|.......\/..............|....-.-../|\.......\../..........\....\./....-.....|..../.../.........",
            @"........\...../......|.................................-...........................-.-.....|............|../..",
            @"-../.............\.....|..\......|.../........................./...-...../............../\-.........-.........",
            @"...........\.........-....................-.....\...............-.................\...-.../.......\...........",
            @"./........................\................-..../.\........./......-....|.............../.-.........../......\",
            @"....................-.............\.......\-................|................-.......................|..|.....",
            @".......\.../.....|./..\..........-.........../.......|.................-..................|.|................/",
            @".....\....|.................\.-./........|.........\..-.........\....\.......|...\....-...............-.......",
            @"......................................-...........-|..|.../..\...\.\../.................-|......\.....-.......",
            @"......|........|......................|....././....././........./......................-./...\................",
            @"..........\........|.....\......\......................|......./....................../.\............-.....|..",
            @"|.....-............./........|...\../.......|......../\.|.-......\.\........|....\............./..........\...",
            @"-.......................|..|/...........-.......-.....-............-........................./................",
            @".......|....-......................\..........................-...|...........................................",
            @"\......\........|.\..\.............\-..............\./......................-.....|...../..|..-.............|.",
            @"......-.............................../......-........-|............-..........-.....\//.-/.....\..........-\.",
            @"...............................|.........|/.../................................................|.............."
        ];

        private enum Item
        {
            None = '.',
            HorizontalSplitter = '-',
            VerticalSplitter = '|',
            ForwardMirror = '/',
            BackwardMirror = '\\'
        }

        private static List<(int col, int row)> Trace(Dictionary<(int column, int row), Item> map, (int col, int row) startPos, (int dCol, int dRow) startDirection, int width, int height)
        {
            HashSet<(int col, int row, int dCol, int dRow)> visited = [];

            void SubTrace((int col, int row) currPos, (int dCol, int dRow) direction)
            {
                currPos = (currPos.col + direction.dCol, currPos.row + direction.dRow);

                while (currPos.col < width && currPos.row < height && currPos is { col: >= 0, row: >= 0 } && !visited.Contains((currPos.col, currPos.row, direction.dCol, direction.dRow)))
                {
                    visited.Add((currPos.col, currPos.row, direction.dCol, direction.dRow));

                    if (map.TryGetValue(currPos, out Item value))
                    {
                        switch (value)
                        {
                            case Item.HorizontalSplitter:
                                if (direction.dRow != 0)
                                {
                                    SubTrace(currPos, (+1, 0));
                                    direction = (-1, 0);
                                }
                                break;

                            case Item.VerticalSplitter:
                                if (direction.dCol != 0)
                                {
                                    SubTrace(currPos, (0, +1));
                                    direction = (0, -1);
                                }
                                break;

                            case Item.ForwardMirror:
                                direction = (-direction.dRow, -direction.dCol);
                                break;

                            case Item.BackwardMirror:
                                direction = (direction.dRow, direction.dCol);
                                break;

                            case Item.None:
                            default:
                                throw new ArgumentOutOfRangeException();
                        }
                    }
                    currPos = (currPos.col + direction.dCol, currPos.row + direction.dRow);
                }
            }

            SubTrace(startPos, startDirection);

            return visited.Select(p => (p.col, p.row)).Distinct().ToList();
        }

        public static void Run()
        {
            string[] data = DataProd;

            Dictionary<(int column, int row), Item> map = data.SelectMany((line, row) => line.Select((c, column) => (column, row, item: (Item) c))).Where(t => t.item != Item.None).ToDictionary(t => (t.column, t.row), t => t.item);

            int width = data[0].Length;
            int height = data.Length;

            Console.WriteLine($"Day 16 Part 1 Answer is {Trace(map, (-1, 0), (1, 0), width, height).Count}.");
            Console.WriteLine($"Day 16 Part 2 Answer is {Enumerable.Range(0, width).Aggregate(new List<int>(), (curr, col) =>
            {
                curr.Add(Trace(map, (col, -1), (0, 1), width, height).Count);
                curr.Add(Trace(map, (col, height), (0, -1), width, height).Count);

                return curr;
            }).Union(Enumerable.Range(0, height).Aggregate(new List<int>(), (curr, row) =>
            {
                curr.Add(Trace(map, (-1, row), (1, 0), width, height).Count);
                curr.Add(Trace(map, (width, row), (-1, 0), width, height).Count);

                return curr;
            })).Max()}.");
        }
    }
}
