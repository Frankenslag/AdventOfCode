
using System.Dynamic;
using System.Security.Cryptography.X509Certificates;
using System.Text;

namespace AdventOfCode2024
{
    internal class Day9
    {
        private static readonly string[] Data =
        [
            "17713161803125501636333876277154596754444934684564879316542964667067379718863482",
            "17818322649127839247846366401635499379527240761759913557199723191566132314473452",
            "16461959243583521487201716837628833124493381702067726921797854929569587535915928",
            "40119573489592801732121267413336365381205026364253613337751741431027917239525914",
            "75196491167856991516691839536984515858517672205855136040353121741391649236793056",
            "99988774618571247753719345421793828363139356814090115449723857295994799194572845",
            "45458792246153836976801536163642242732358354478648127399229786553591619298795649",
            "60369338644862103745556477716977633390413522137821334095486890365093449539954624",
            "38945196919214437572809895199311603021731584955136957026272614689238203738398538",
            "43829071353577181536369098643188912512659982198564537957264453977361255491518926",
            "78327646735985586735964188799476938078313997849810601815504336227862111584345740",
            "13513042668714802436523366386126987588109516149317889976519434789612641873815737",
            "51974960472219629254454972306418593271321332831381686513215336983934282517885164",
            "52585378792157417476551839876327291574514039584563695412134363944634411647824274",
            "16193599649921227259641034266490808187969121773693678473723865531462517626443538",
            "83378192329578444685464468731968728191458880739356406552225773516089982472601163",
            "72494487966427393557933728818159657144333818784661536424449621573815318043675647",
            "15233466702047558585367170912365599828801878205243863674414262539257649670434288",
            "20679738228179625523743817428461623210846467589949768427501348385549998310309253",
            "98386332776460628364593745414333396669876437976061527985121670497192209893409363",
            "30886155909451693752303492233370758173374099254537986553454241776186368357611495",
            "87277839516661686120715217421399644969565441202350102754943751936017242439736043",
            "81849083114263334078638397664041815945974828906153815371311619319551465438796055",
            "53866257685446611936786856985531409237427489259197878563872617645659336023447156",
            "74797627565036756748703693495193154954193778424960437125711270327596474795144174",
            "35686014102581558773237550753716138015637760968681603082385463896144304080858867",
            "25971142438835859633823648644641694512689638955489588057509234261642247890245192",
            "32713138178413846683172581787845632418411340718098672966344919882337666060395440",
            "80902868458980372592558813352343504919672089894796563052208517259038235010502375",
            "40938920887741108344196618837164753111974079222964112086498934111290105378786567",
            "89758628699596135986625998573354488547853321665442619413907545364695855939616431",
            "55175949163642189293747087694867118953332243968688392886953277836336899852147998",
            "30724020519938222281622940117322779655947688116970648422403968947895153880354819",
            "66181537892956627375162524897577622389246396722688754460165054379334654225836523",
            "14786642109963422558871656963296454194743771349898724869667250337215475929665811",
            "27659944267193461322366369848333333027584662553966128479223073646583615220808760",
            "16592516858728332540108222692114303823959777987389925477424539641211219294615768",
            "50509053426290141892103981927463163917956216791358339372667156937037278517844415",
            "75825876351910995790476260969793185894131197387252958581645445915986709573977613",
            "70471656929639437482256565677569177347469648879351711771137977229854545024788633",
            "18535429823724188937163935172576318571203660664677744579677457572730333635506298",
            "53847961811676425270335627907849236684654894214365641654486449799139813438226980",
            "44832883505985659044421253391555403913741262699139236323679987727131837227568294",
            "55581661386964816631831447485225341569921189526739784534847733919224398968742957",
            "32764926242234664578443669202693482530999747333958519589981716337028123531498054",
            "99514544593547504932914264993243469744684220514360469078864058963374227142795791",
            "67126592838513549325747686526564719782112687918258554380875321822361264822656954",
            "21681684549914581159767221364120463542693761214174942385895869833819567915884330",
            "56764163906910182536407394225168805853293130978362785497221433874475537576462165",
            "27409563483928654769315065498482732489654943621541423688686454245358839934559794",
            "69882087744362938683344518197017952043357250824476873621544736466910352756321532",
            "30287635692224547898809080317477673563859993748615751692768049749956396848398350",
            "89988598199572774772816780433694514661234982835572256145171589234788964133575140",
            "58775353831373848765807624695222497131991691341864824373648142316758432033248920",
            "18613676706557807733185536223157871193591453558851551516947051876943545110877210",
            "54761062794556416894963572975812238073578281495464875632255613971878184083264844",
            "72185643317898261577544368258040929971151976627511574612773291461033404560552853",
            "52386648122785769339525674358413516138602582985252456625873369705121246568471868",
            "28694083749348565753653265665882196950284736122724148231584693161863605361777596",
            "83627540898986603514218285233747925248486213747943286536167327452656185151849214",
            "55911858921423345648652383185987145847901197613539863251259757739288511517128285",
            "44415773547955874896854482899984149836786247307045293043305725235542442480253588",
            "31768070288579983077361028216792962063879788378455808525151738664433586590206442",
            "96867670533920452491719172314125167569858342863498312392232858444197239256906526",
            "91436848696044874081594595136357234592568032112716198333657856156887701231808047",
            "24298543712938202249746292949794178371853367584359213621728124879228255862245422",
            "73675011214163942350794262155299787768903057133969274795221939422890172822546118",
            "87855327359784997619974542589192151448471826144248534274774940215943682298196313",
            "21831650915925894192634422523080228083211223198072701872497434788231863485299691",
            "37769778865688397334172758377831301066197790162834699481238951187469449394618155",
            "84963513302047151181885277841283294755388768781816183678399833623643372434388878",
            "36433067905529936869357648417115182447742454928173107078165758703865167799583466",
            "86968543332275793522283587719454524078467769733790128052325637927769484110156273",
            "82878279992795674580104499716445727649654824359730103973746432165577389028704616",
            "82677787452126221350338070423937148043566124147566381027673810519088994064747353",
            "77402761598744913411376432893043693915365065854352341969524357882585694183279829",
            "54227895542917867462381340558351747132489032592069102853533579868040638554408029",
            "80323477953442895812649885636190717237415662586424221958953420541055423419513434",
            "21527946817786753022657373253536139378489343958961184314505177712884298763819866",
            "70706434704361182046476762372029745728159415879584602773368769615374793771107133",
            "26895145516074737049105823451017773219936328183589958531725566947548931456952512",
            "13246948686330292320686417148956431239371882231215104133239233646244385314861639",
            "33522125883511253739179996807675761372424599195187224277837146114313417857597381",
            "71377967675861857452539218414165104242506679947080404054587491308892599550979514",
            "14511464152832145634753884109649999888278847726363499842698311728378808575916930",
            "51923462215783673122351193922083505969925573897928568824258765656998797962919138",
            "38711572862397444991211881832730875281292139963438206326417246307091385374125983",
            "55348373812631432859943826871380122410494171163612445384832436216130166893795671",
            "45964256595249862987332762849893342024378086329023986229275718747884755611293690",
            "97692111229881608058971543619975184546612843296710759281964280339579495144724373",
            "17833317863420889339499954827294866034956949413215771910963858832592197857971337",
            "48179856379482365072991581808229312648947845958295503626304089535015672252626554",
            "14652120833239686036935537377575506493873866554131718263517466676294339440672966",
            "88188253568012476275544712633988802281993530805779212944433334722310377634799382",
            "77985559917044482236664640601963822787297159648426583045741558486354842920833358",
            "14759886243684958995661898638897594138807639923055516751747115282486266075836932",
            "23186017429416203778352176879473665770153055705429778224502461632563912266538271",
            "80965226808460891716802498167075193877346952509629682281977768321713192146255543",
            "14216635449029702132178122865438439960634124408976203389919839619977781961571384",
            "45944220827750198940466051249244742076285086699599747968744012172884688970654120",
            "17413689441662907846512517883854161928334860238572617093733177123118489254785342",
            "11809538414223141463139975252511333566988555748771963755871856732483974190731387",
            "73457453695640483421846310657082284034475766717998161939494332409848609618982384",
            "29203153862383163532205842622081359127646971936538504363558162325374188150244528",
            "91766938912333109073855188512521761573662279817347639096975540924411758469873948",
            "97555089935321268449512738895162178119184313839942523461931466192131301183811679",
            "84174112791288831291184896133178231699408465528255617856768475641730528768461195",
            "50456544922237268625541395474160368498458981202769731832734830458649626544171735",
            "39278311881879232222122376292817984229767086969558107728398072191577954821806429",
            "67991015387071342678694257862018804972208872313334672127613171469883202211566999",
            "50632564721219496922227276824965774635599782826161385058862047873454138541682727",
            "56191679752678743845216595804798869627246987893858174844946069501742828611743934",
            "26224538558711572747834444188460598273446226203642748191352086463311967857722091",
            "61441787741782411888423764642876949636531566844047829764461793631589764953322779",
            "78697057994070156150771643286439609528753958682147712895354479291113549789381151",
            "86927096109351274587504921397643639139438215963754506962206335266155175360904952",
            "23595264466140901751762124123811526579677981808398432351997212133215607376547070",
            "77957293676623655038456554629935777238607216639789333760865633429747935693369181",
            "85758032877286616943999581868271784045463433777153206121974431159516139246485121",
            "36569114348685743221311352642289671673697229445175938979469635951043889760924634",
            "34315538777354145463309435885239985538952462184120379594709183276566699613785497",
            "87751849265710121250582736891536122332601382684382541151811417153814258772786359",
            "71655451283350801329342734583797755543569613631087921292541233314382524577665529",
            "97133318397466599483897887302416847244817882275861453492815151353470542150697043",
            "94861972353359665140729619621884648095382740932216936269431145807987827282797691",
            "93649316968288378675965319945223696448367855565170299279489282811812392579481956",
            "33991871401561236312867549622818218592598795113342634624459791223425121867907639",
            "15384992753957329646493435516776412467783381665856812655589349267330572252229042",
            "83637545958759517881908215926628572336539248564331183591494259687665516127473553",
            "21256139632734445651292039592598107886593232532233244523861799883457263812195133",
            "86926913712714838012173712824567114427385520758686684557641897555444344679164997",
            "48973671385332793320314291255764143025852137161699639029225577397647476510947688",
            "20778418909987614179194923351263717629716210975060994796646038362464454130571053",
            "62369537418113609079227717553734548415158120445419508560252669314230892572537187",
            "20233753483642743859849872673984586575553165517688532245249551775785223397784892",
            "32225786914128924444373985122238887482866289739274685698529449145013331776142441",
            "40247299199620881045225271908837166725378047916944678713551443847126555524735271",
            "87708665484539571079335566822548351935778291382264185277699553421318772660877519",
            "64647810683899663682181361552376276636775413638983434516769480779064587196828380",
            "45281591645721775298797151166548581795702894762995802889392024849569134891594630",
            "32292178794379215313713722944916428516743029862010247734626871789844368538991552",
            "31993343826754158576225838748829158583129640273121586851329341654963396979857231",
            "97373735668049339753113272104119228732584860949637205120339361592543942442826771",
            "45393876473029231129851328891158219635956566323947796683194581526915142441489889",
            "62365926546723942247353760984558136189495171807469365612308365727746327259572681",
            "38481232429481508461276290582975396447513636154017861228894344646740573388277846",
            "88465067541431952170902045104313844824939539106073612651331885272562521462661078",
            "12688897438198162951725152736224886992989035406891465338472248761495818425958056",
            "10619619473067774658509579567447846941882161141358797977723657676656929621285759",
            "65862812775964987086994679265215281558746179609035705271639293317514762687565696",
            "73417971886878428885366187494588374094313951205646964850948588435245189243186414",
            "60623295422881381275311264759268699553566019913980759066445766627137882265256747",
            "62556882457463271867887693921730231679404496394095717929528556826145286025537260",
            "22746084411412507578894824553510318369574073595867437170846743977539726083775598",
            "77797852734493791395741448889952283748379086376416202924763699809859722633926652",
            "61958547635272414313219687131659732541911593309731983225691912392868226749234188",
            "25653852319731909242413685273152108754101895575938925027317534211484902516252428",
            "61429436438195498766444312567348441661575133193284136915277027806419633696945898",
            "56939920439436477930169823941429667156731386182795911091402662995678458676852377",
            "15772516364877435713813720389859834626571186873997183914387073564830723537762322",
            "14815592662221613037619038276595153092824512869049399030735428521588764134873755",
            "56202614816422975496576917269650857038384251404586599855213926669789562970738287",
            "10321855191229613372494520197884521857679195158095466447779356359194705513355929",
            "13275684101061485921598235868860362153385619869870137260633572687160246438151762",
            "88847423517259936219252547316946952911184156887895339525781934326879305377143621",
            "12626152262172878589396496477693902952728166551722599773198038913044246094692357",
            "44532640503574391689123146285120819283164616168255472474262147545383877077353019",
            "14682167748261745214973623741412582934399293539162805139362684573445676651397327",
            "51931432553895548277731982146454325958736483462554281412928628767282413380905735",
            "11307619288362703368381846937426258723141912402680827659731023161567115091802319",
            "93352010517034321226465512252667536612286882339717941433345371824238778928947415",
            "33243322403973588934295781941354189072641362252241232188475812978310554079127384",
            "96522417184295872373956739248661768610275871192169685810166752311452467530889173",
            "42655897101177857011929132759841204588244515728383161532478175859766439097399653",
            "42103360689221983337811283196445472545673922202728396619482220528427196586706860",
            "45686680797817844299373555916912115823768249696845761797148464585073243142249627",
            "20309173447290873234601960954756737964856861133391639039306842582071339457393881",
            "23752466475023675314847173757659217196486267517745497869917717155213139364776093",
            "99359558106414499979884596429288249766431149508582152731644522972096372762337069",
            "35777626151717817167852131735733678357944631313889458850906796996388726176818441",
            "36443517566787814720573229321329575487255325706572549923361425894512151943902761",
            "16427714823814315786907975205942627171362443314763316549867813798524452410472777",
            "58942079671021316930773049113550527241329144236984561532868249803620347612398273",
            "57835066868426182265125767809999774860676533615119471394647744819962918417791454",
            "14865787369845717818945726391781257958292486265325261743401664411371932129584667",
            "40232668742014668373584326278818349016665618279284701179226956277083329520913576",
            "23352365393226319138533035598266903482138595782229267682309777217478738265127136",
            "32438283475439506959199181739542224459931856616593148836886942656596389616834859",
            "47698356163871759950295720285643671364926746267813857519801272405559469784918299",
            "91636068391263308514554440523796187298289184779944482921707335627180567344793591",
            "72903190533471678973354286877071644629478054739592833544163515256785854825405439",
            "41482511758720705179481853246414946878548143803597763819254685383153363672598154",
            "94159484705762781267957986526850704199737581939375221523986611528913943167502326",
            "53123515395152294257257667931725561866359921607145237038366699713110741727958459",
            "58272638805992174490228763553441606952947240568989751584185627648988745797908166",
            "16933675809363299818528042733214468659779618397833746695275070382699219817866537",
            "57524057115282778815987325973238774261325214499996571625485519375188367166194076",
            "21625876394692227826148016244035114391498193228931629078983258133210674935777549",
            "34705771894663941091744664983080609467243395151587657796958165982090743521644194",
            "39764735982954405697138694935131663135904397811892568217991318531065556115429195",
            "43882793513037755475975675884930698079366498533314102580314676611022301670896097",
            "87997063897871398399774618458742858873597260546492451242986253726445867132401976",
            "26631354758876679730119299702828411876231955888943803075104210524241908511565898",
            "97686978565268964891934741593299183961158665504453105175903129157137475578163340",
            "97958520591330452528437114954496313393974816734230486856182366522858997844116081",
            "21859189454924133651722219619524791743806691778771215723558770373329195946513690",
            "38482026196078189415855895981579842780347396589833833913488019942818187470432965",
            "52924156821281112982975433228558951125559447908123879881667877363182272049846032",
            "14759010279499772468185268201671331228573473717968497355838136225123132952321147",
            "74159970484269177966507587179117556035692651257024237820662578285678391437522768",
            "27982311457956686795719213322578175842715812431019512931125984957790466588595869",
            "22452948704949178096246616406868857518627310735543398947962769161348232681887386",
            "72889167368237232486289122122283577599839565792340618964559326997381196938449971",
            "73864651502480523855926976803683487991166719385339372213714075312938381233684330",
            "22328546585943262637193380629852212460471931923647426675261513557652555481886996",
            "79812036218820759317516846778947143528107528565558534928859591703093376487472075",
            "11317922749086708180685738887370329667312957667083208613503980788091858276582914",
            "39448582944711787243837532646063908493641362714141385218379993545992415933126761",
            "88593123799338812574809179213998749193984249498382658980908463523919839288542118",
            "22239586701697843843475622434741521540783262775365214278696698693395903484196223",
            "78118679158923593567986691211272396292792572377724447990505394323393976332189657",
            "35148866139360989993954442999437644970938382199027763765224119523449753994861173",
            "58589964667360844018178339517156808995589822324042576471251999708941102766416486",
            "40751093321191493973659419124128154545585182206552164569325152568034314147832373",
            "97602779779017437021523836284653836514876340284557377525851579799360362365137699",
            "82777170585512394678744720986960376265252338724117323197346932606181358972227410",
            "68593657817290464492712550585234347618885037714276723522359179613543886619767128",
            "74328237153044251286746433625492744757921530734699829417487761681845544687693447",
            "84264292733610233318943157761267363569828148403523533037586867443033637459541790",
            "31472583202774371359293328397433965268369725709649432711847153624996897479684062",
            "11302870498595754254701391893621979178214848248593882686826437802059521448952253",
            "67981279997699311686593574145688113050567127534013434664903965529576582134366635",
            "73166584361140884233355287581825985875281345572017725967778376648876706049997327",
            "14685927355355343193181537433958169086615759957326928772362638386467308215347212",
            "55275488611447302959907989113472804042281778106448706194938189571316614558513543",
            "59485667981587647724724095229768533075322335906553444285669212882821984015428064",
            "99362115929638699532509716959631206646731977449857139397407872479424504234537728",
            "30358223591928298663157483116733747732853299335494676765269766348033774682556040",
            "66208010343791938863272830119295733386519322523131804518106493556037774234424566",
            "12737516987921613652909476828297462778378280327884755057272034593374465935938411",
            "82334068604773425656704544968164302341191939655058915053529051178244604069776867",
            "42135253283940709336647491161645233831372045408185876033318552679494439042207684",
            "18204698152943123051547498488531581932341489408162756994456624804133244256881074",
            "60577584991393922125126825281043632456495967577229881676272168932154791810287874",
            "12735886379856278283494861487829376723248791108892794990689595683230102130786592",
            "66472657338175448015459081181834439595929122666673441042688532218022443253384255",
            "61158033207557504042428126167882505739949715923584267684595384799987564737448224",
            "69496213971646414088415714409172486435306811369923241185943197968131662244135763",
            "56607755826649691484536711141350829890223258734574128587127157514087111489799276",
            "6867625687607356396015966396565327326062879120829796901778501612877789268687323"
        ];

        private class Allocation(int id, byte length)
        {
            public int Id { get; set; } = id;
            public byte Length { get; set; } = length;
        }

        public static void Run()
        {
            for (int part = 0; part < 2; part++)
            {
                List<Allocation> allocations = Data.Aggregate(new StringBuilder(), (curr, next) => curr.Append(next)).ToString().Select((c, i) => new Allocation(i % 2 == 0 ? i / 2 : -1, byte.Parse(c.ToString()))).Where(a => a.Length != 0).ToList();

                allocations.Add(new Allocation(-1, 0));

                if (part == 0)
                {
                    while (allocations.Count > 0 && allocations.FindIndex(a => a.Id == -1) < allocations.FindLastIndex(a => a.Id != -1))
                    {
                        Allocation lastFile = allocations!.FindLast(a => a.Id != -1)!;
                        Allocation targetSpace = allocations!.Find(a => a.Id == -1)!;
                        Allocation lastSpace = allocations!.Last()!;

                        if (targetSpace.Length == lastFile.Length)
                        {
                            //convert last file into space
                            lastSpace.Length += lastFile.Length;
                            allocations.RemoveAt(allocations.FindLastIndex(a => a.Id != -1));
                        }
                        else if (targetSpace.Length < lastFile.Length)
                        {
                            lastSpace.Length += (byte)(lastFile.Length - targetSpace.Length);
                            lastFile.Length -= targetSpace.Length;
                        }
                        else // targetSpace > lastFile
                        {
                            allocations.Insert(allocations.FindIndex(a => a.Id == -1) + 1, new Allocation(-1, (byte)(targetSpace.Length - lastFile.Length)));
                            targetSpace.Length = lastFile.Length;

                            //convert last file into space
                            lastSpace.Length += lastFile.Length;
                            allocations.RemoveAt(allocations.FindLastIndex(a => a.Id != -1));
                        }

                        targetSpace.Id = lastFile.Id;
                    }
                }
                else
                {
                    foreach (var sourceFile in allocations.Where(a => a.Id >= 0).OrderByDescending(a => a.Id).ToList())
                    {
                        int sourceFileIdx = allocations.FindIndex(a => a.Id == sourceFile.Id);

                        int targetSpaceIdx = allocations.FindIndex(a => a.Id == -1 && a.Length >= sourceFile.Length);

                        if (targetSpaceIdx >= 0 && targetSpaceIdx < sourceFileIdx)
                        {
                            if (allocations[targetSpaceIdx].Length > sourceFile.Length)
                            {
                                allocations.Insert(targetSpaceIdx + 1, new Allocation(-1, (byte)(allocations[targetSpaceIdx].Length - sourceFile.Length)));
                            }

                            allocations[targetSpaceIdx].Id = sourceFile.Id;
                            allocations[targetSpaceIdx].Length = sourceFile.Length;

                            sourceFile.Id = -1;
                        }
                    }
                }

                int index = 0;
                long checksum = 0;

                foreach (Allocation alloction in allocations)
                {
                    if (alloction.Id != -1)
                    {
                        for (int i = 0; i < alloction.Length; i++)
                        {
                            checksum += (index + i) * alloction.Id;
                        }
                    }

                    index += alloction.Length;
                }

                Console.WriteLine($"Day 9 Part {part + 1} Answer is checksum {checksum}.");
            }
        }
    }
}
